<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crypto Ichimoku Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
</head>
<body style="background-color:#111; color:white; font-family:sans-serif; text-align:center;">
  <h2>Crypto Ichimoku Dashboard</h2>

  <label for="cryptoSelect">Selecciona una cripto:</label>
  <select id="cryptoSelect">
    <option value="xrp">XRP</option>
    <option value="xlm">XLM</option>
    <option value="hbar">HBAR</option>
    <option value="dovu">DOVU</option>
    <option value="xdc">XDC</option>
    <option value="shx">SHX</option>
    <option value="velo">VELO</option>
    <option value="xdb">XDB</option>
    <option value="xpl">XPL</option>
    <option value="doge">DOGE</option>
    <option value="zbcn">ZBCN</option>
    <option value="paw">PAW</option>
    <option value="dag">DAG</option>
    <option value="xpr">XPR</option>
    <option value="qubic">QUBIC</option>
  </select>

  <label for="timeframeSelect" style="margin-left:20px;">Timeframe:</label>
  <select id="timeframeSelect">
    <option value="1h">1H</option>
    <option value="1d">1D</option>
  </select>

  <button id="infoBtn" style="margin:10px;">‚ÑπÔ∏è ¬øQu√© significa Ichimoku?</button>
  <div id="infoBox" style="display:none; background:#222; color:white; padding:15px; border-radius:8px; width:80%; margin:auto; text-align:left;">
    <h3>Interpretaci√≥n de Ichimoku</h3>
    <ul>
      <li><b>Tenkan > Kijun:</b> Se√±al alcista (momentum positivo)</li>
      <li><b>Tenkan < Kijun:</b> Se√±al bajista (momentum negativo)</li>
      <li><b>Precio sobre la nube:</b> Tendencia alcista</li>
      <li><b>Precio bajo la nube:</b> Tendencia bajista</li>
      <li><b>Nube verde:</b> Proyecci√≥n alcista futura</li>
      <li><b>Nube roja:</b> Proyecci√≥n bajista futura</li>
    </ul>
  </div>

  <div id="chartContainer" style="width:90%; margin:auto; height:600px;"></div>

  <script>
    const cryptoSelect = document.getElementById("cryptoSelect");
    const timeframeSelect = document.getElementById("timeframeSelect");

    cryptoSelect.addEventListener("change", () => loadChart());
    timeframeSelect.addEventListener("change", () => loadChart());
    window.onload = () => loadChart();

    document.getElementById("infoBtn").addEventListener("click", () => {
      const box = document.getElementById("infoBox");
      box.style.display = box.style.display === "none" ? "block" : "none";
    });

    function loadChart() {
      const symbol = cryptoSelect.value;
      const timeframe = timeframeSelect.value;

      fetch(`/api/${symbol}_data?timeframe=${timeframe}`)
        .then(res => res.json())
        .then(response => {
          const data = response.data;
          const alerts = response.alerts;
          const lastUpdated = response.last_updated;

          if (!data || data.length === 0) {
            document.getElementById("chartContainer").innerHTML = "No hay datos disponibles para esta cripto.";
            return;
          }

          const x = data.map(d => new Date(d.timestamp));

          const maxPrice = Math.max(...data.map(d => d.close));
          const maxIndicator = Math.max(...data.map(d =>
            Math.max(d.atr, d.ewo, d.rsi, d.vwap, d.sma_50, d.sma_200)
          ));
          const priceDominates = maxPrice > maxIndicator * 5;
          const useSecondaryAxis = priceDominates;

          const traces = [
            {
              x,
              y: data.map(d => d.close),
              type: 'scatter',
              mode: 'lines',
              name: `Precio ${symbol.toUpperCase()}/USDT`,
              line: { color: '#00BFFF', width: 2 },
              yaxis: useSecondaryAxis ? 'y2' : 'y'
            },
            { x, y: data.map(d => d.tenkan), type: 'scatter', mode: 'lines', name: 'Tenkan', line: { color: 'blue' }, visible: 'legendonly' },
            { x, y: data.map(d => d.kijun), type: 'scatter', mode: 'lines', name: 'Kijun', line: { color: 'green' }, visible: 'legendonly' },
            { x, y: data.map(d => d.senkou_a), type: 'scatter', mode: 'lines', name: 'Senkou A', line: { color: 'orange' }, fill: 'tonexty', fillcolor: 'rgba(0,255,0,0.2)', visible: 'legendonly' },
            { x, y: data.map(d => d.senkou_b), type: 'scatter', mode: 'lines', name: 'Senkou B', line: { color: 'brown' }, fill: 'tonexty', fillcolor: 'rgba(255,0,0,0.2)', visible: 'legendonly' },
            { x, y: data.map(d => d.vwap), type: 'scatter', mode: 'lines', name: 'VWAP', line: { color: 'purple' }, visible: 'legendonly' },
            { x, y: data.map(d => d.sma_50), type: 'scatter', mode: 'lines', name: 'SMA 50', line: { color: 'cyan' }, visible: 'legendonly' },
            { x, y: data.map(d => d.sma_200), type: 'scatter', mode: 'lines', name: 'SMA 200', line: { color: 'magenta' }, visible: 'legendonly' },
            { x, y: data.map(d => d.rsi), type: 'scatter', mode: 'lines', name: 'RSI', line: { color: 'yellow' }, visible: 'legendonly' },
            { x, y: data.map(d => d.atr), type: 'scatter', mode: 'lines', name: 'ATR', line: { color: 'red' }, visible: 'legendonly' },
            { x, y: data.map(d => d.ewo), type: 'scatter', mode: 'lines', name: 'EWO', line: { color: 'lime' }, visible: 'legendonly' }
          ];

          const layout = {
            title: `${symbol.toUpperCase()} Indicadores T√©cnicos (${timeframe})`,
            xaxis: { title: 'Fecha y hora' },
            yaxis: {
              title: useSecondaryAxis ? 'Indicadores' : 'Precio (USDT)',
              automargin: true
            },
            template: 'plotly_dark'
          };

          if (useSecondaryAxis) {
            layout.yaxis2 = {
              title: 'Precio (USDT)',
              overlaying: 'y',
              side: 'right',
              showgrid: false
            };
          }

          Plotly.newPlot('chartContainer', traces, layout);

          const oldAlert = document.getElementById("alertBox");
          if (oldAlert) oldAlert.remove();

          if (alerts && alerts.length > 0) {
            const alertBox = document.createElement("div");
            alertBox.id = "alertBox";
            alertBox.style.background = "#222";
            alertBox.style.color = "white";
            alertBox.style.padding = "10px";
            alertBox.style.margin = "10px auto";
            alertBox.style.width = "80%";
            alertBox.style.borderRadius = "8px";
            alertBox.innerHTML = `<h3>üìä Se√±ales detectadas:</h3><ul>${alerts.map(a => `<li>${a}</li>`).join("")}</ul>`;
            document.body.appendChild(alertBox);
          }

          const updateBox = document.createElement("div");
          updateBox.style.color = "#aaa";
          updateBox.style.marginTop = "5px";
          updateBox.innerText = `√öltima actualizaci√≥n: ${lastUpdated}`;
          document.getElementById("chartContainer").appendChild(updateBox);
        });
    }
  </script>
